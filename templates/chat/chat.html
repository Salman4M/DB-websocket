{% block content %} 

<wrapper class="block max-w-2xl mx-auto my-10 px-6">
    {% if chat_group.groupchat_name %}
    <div class="flex justify-between">
        <h2>{{ chat_group.groupchat_name }}</h2>
        {% if user == chat_group.admin %}
        <a href="{% url 'edit-chatroom' chat_group.chat_name %}">
            <div class="p-2 bg-gray-200 hover:bg-blue-600 rounded-lg group">
                <svg class="fill-gray-500 group-hover:fill-white" width="16" height="16">
                    <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z"></path>
                </svg>
            </div>
        </a>
        {% endif %}
    </div>
    {% endif %}

    <div id="chat_window" class="h-[45rem] flex flex-col bg-gray-800 rounded-2xl shadow-2xl relative p-1">
        <div class="flex justify-center text-emerald-400 bg-gray-800 p-2 sticky top-0 z-10">
            {% if chat_group.groupchat_name %}
            <ul id="groupchat-members" class="flex gap-4">
                {% for member in chat_group.members.all %}
                <li>
                    <a href="{% url 'accounts:profile' %}" class="flex flex-col text-gray-400 items-center justify-center w-20 gap-2">
                        <img src="{{ member.profile.prof_image }}" class="w-14 h-14 rounded-full object-cover" />
                        {{ member.profile.name|slice:":10" }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div id="online-icon"></div>
            <span id="online-count" class="pr-1"></span>online
            {% endif %}
        </div>

        <div id="chat_container" class="overflow-y-auto grow">
            <div id="chat_messages" class="flex flex-col justify-end gap-2 p-4">
                {% for message in chat_messages reversed %}
                    {% include 'chat/chat_message.html' %}
                {% endfor %}
            </div>
        </div>

        <!-- Chat input (no <form>) -->
        <div class="sticky bottom-0 z-10 p-2 bg-gray-800">
            <div class="flex gap-2 items-center">
                <input 
                    id="chat-message-input"
                    type="text"
                    placeholder="Add message..."
                    class="flex-1 p-2 rounded-md"
                    maxlength="300"
                    autofocus
                />
                <button id="chat-message-submit" class="p-2 bg-blue-600 text-white rounded-md">Send</button>
            </div>
        </div>
    </div>
</wrapper>

<!-- Room name for JS -->
<span id="room-name" hidden>{{ chat_group.chat_name|json_script:"room-name" }}</span>

<!-- WebSocket JS -->
<script>
const roomName = JSON.parse(document.getElementById('room-name').textContent);

const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
);

const log = document.getElementById('chat_messages');
const input = document.getElementById('chat-message-input');

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const div = document.createElement('div');
    div.textContent = `${data.author}: ${data.content}`;
    div.classList.add('p-1', 'text-white', 'rounded-md');
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;  // auto-scroll
};

chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
};

// Enter key to send
input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        document.getElementById('chat-message-submit').click();
    }
});

// Send button click
document.getElementById('chat-message-submit').addEventListener('click', function() {
    const message = input.value.trim();
    if (message) {
        chatSocket.send(JSON.stringify({ content: message }));
        input.value = '';
    }
});
</script>


{% endblock %}
